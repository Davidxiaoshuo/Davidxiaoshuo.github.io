<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="author" content="David硕"><meta name="subtitle" content="write readable code"><meta name="description" content="在这个薄情的世界，深情地活着"><title>Swift 静态 vs 动态 分派 | David硕</title><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script src="/js/script.js"></script><script src="/js/tocbot.min.js"></script></head><body><div class="wrapper"><header><nav class="navbar"><div class="container"><div class="navbar-header header-logo"><a href="/">David硕&#39;s Blog</a></div><div class="menu navbar-right"><a class="menu-item" href="/archives">Posts</a> <a class="menu-item" href="/category">Categories</a> <a class="menu-item" href="/tag">Tags</a> <a class="menu-item" href="/about">About</a> <input id="switch_default" type="checkbox" class="switch_default"> <label for="switch_default" class="toggleBtn"></label></div></div></nav><nav class="navbar-mobile" id="nav-mobile"><div class="container"><div class="navbar-header"><div><a href="/">David硕&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a></div><div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div></div><div class="menu" id="mobile-menu"><a class="menu-item" href="/archives">Posts</a> <a class="menu-item" href="/category">Categories</a> <a class="menu-item" href="/tag">Tags</a> <a class="menu-item" href="/about">About</a></div></div></nav></header><script>var mobileBtn=function(){var e=document.getElementsByClassName("menu-toggle")[0],t=document.getElementById("mobile-menu");e.classList.contains("active")?(e.classList.remove("active"),t.classList.remove("active")):(e.classList.add("active"),t.classList.add("active"))}</script><div class="main"><div class="container"><div class="post-toc"><div class="tocbot-list"></div><div class="tocbot-list-menu"><a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a> <a onclick="go_top()">Back to top</a> <a onclick="go_bottom()">Go to bottom</a></div></div><script>function expand_toc(){var o=document.querySelector(".tocbot-toc-expand");tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:6,orderedList:!1,scrollSmooth:!0}),o.setAttribute("onclick","collapse_toc()"),o.innerHTML="Collapse all"}function collapse_toc(){var o=document.querySelector(".tocbot-toc-expand");tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:1,orderedList:!1,scrollSmooth:!0}),o.setAttribute("onclick","expand_toc()"),o.innerHTML="Expand all"}function go_top(){window.scrollTo(0,0)}function go_bottom(){window.scrollTo(0,document.body.scrollHeight)}document.ready(function(){tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:1,orderedList:!1,scrollSmooth:!0})})</script><article class="post-wrap"><header class="post-header"><h1 class="post-title">Swift 静态 vs 动态 分派</h1><div class="post-meta">Author: <a itemprop="author" rel="author" href="/">David硕</a> <span class="post-time">Date: <a href="#">六月 19, 2021&nbsp;&nbsp;19:15:37</a> </span><span class="post-category">Category: <a href="/categories/iOS/">iOS</a></span></div></header><div class="post-content"><h3 id="前言"><a class="markdownIt-Anchor" href="#前言"></a> 前言</h3><p>在讨论关于 Swift 的静态分派和动态分派之前，需要先弄清基本概念。</p><ol><li><p><code>值类型</code> 和 <code>引用类型</code>: 值类型，存储在栈中；引用类型存储在堆中。在 Swift 中，<code>struct</code>、<code>enum</code> 属于值类型，存储在栈上，<code>class</code> 属于引用类型，存储在堆上。</p></li><li><p>值类型，引用类型都支持静态调度，但是动态调度只有引用类型是可以支持的。</p></li><li><p>调度技术实际上是有 4 种的：</p><ul><li>Inline 「Fastest」</li><li>Static Dispatch</li><li>Virtual Dispatch</li><li>Dynamic Dispatch 「Slowest」</li></ul></li></ol><h3 id="静态-vs-动态"><a class="markdownIt-Anchor" href="#静态-vs-动态"></a> 静态 VS 动态</h3><blockquote><p>何为 <code>静态</code> 和 <code>动态</code> 分派：在执行方法时，首先要做的事就是找到方法，而能够在编译期就确定方法的方式就叫做<code>静态分派</code>，而无法在编译期确定，只能在运行时确定执行方法的方式就是动态分派。</p></blockquote><h4 id="static-dispatch"><a class="markdownIt-Anchor" href="#static-dispatch"></a> Static Dispatch</h4><ul><li>有时称为直接调度。</li><li>如果方法是静态分派的，编译器可以在编译时定位指令所在的位置。因此，当调用该函数时，系统会直接跳转到该函数的内存地址执行操作。这种直接行为导致执行速度非常快，并且还允许编译器执行各种优化，例如内联。事实上，由于巨大的性能提升，在编译管道中有一个阶段，在该阶段编译器尝试使函数静态（如果适用）。这种优化称为去虚拟化。</li></ul><h4 id="dynamic-dispatch"><a class="markdownIt-Anchor" href="#dynamic-dispatch"></a> Dynamic Dispatch</h4><ul><li>使用动态调度只有在运行时才知道要执行的是哪个方法。</li><li>Swift 提供了两种实现动态的方式：表调度「Table」和消息调度「Message」。</li></ul><h5 id="table-dispatch"><a class="markdownIt-Anchor" href="#table-dispatch"></a> Table Dispatch</h5><ul><li>基于继承关系的多态实现「Inheritance-Based Polymorphism」，一个类与一个所谓的虚拟表相关联，该虚拟表「V-Table」包含一个函数指针数组，该数组指向对应于该类的实际实现。请注意，V-Table 是在编译时构建的。因此，与静态调度相比，只有两条额外的指令（读取和跳转）。所以理论上分派应该很快。</li></ul><p><em><strong>[V-Table 内存结构]</strong></em><br><img src="https://raw.githubusercontent.com/Davidxiaoshuo/blog_source/master/resources/images/swift-v-table.png" alt="V-Table 内存结构"></p><ul><li>没有继承或引用语义的多态 「Protocol-Types」, 管理这个协议类型的方法表是 <code>Protocol Witness Table</code> 简称 <code>PWT</code>.</li></ul><p><em><strong>[PWT 内存结构]</strong></em><br><img src="https://raw.githubusercontent.com/Davidxiaoshuo/blog_source/master/resources/images/swift-pwt.png" alt></p><h5 id="message-dispatch"><a class="markdownIt-Anchor" href="#message-dispatch"></a> Message Dispatch</h5><ul><li><p>事实上，是 Objective-C 提供了这种机制（有时，它被称为消息传递），而 Swift 代码只是使用了 Objective-C 运行时库。每次调用 Objective-C 方法时，调用都会传递给 objc_msgSend，后者处理查找。从技术上讲，该过程从给定的类开始，并迭代类层次结构以提取实现。<br>消息调度是三者中最动态的。作为权衡，虽然查找性能由缓存机制保护，但解析实现的成本可能会有点昂贵。<br>这种机制是 Cocoa 框架的基石。查看 Swift 的源码，你会发现 KVO 是使用 swizzling 实现的。</p></li><li><p>Swift 中实现 Message Dispatch, 需要在方法前添加 <code>@objc dynamic</code>。 在 Swift 4.0 之前，<code>@objc</code> 是被隐式添加的，在 4.0 以后，需要我们手动添加。</p></li></ul><h3 id="swift-中的方法分派-case"><a class="markdownIt-Anchor" href="#swift-中的方法分派-case"></a> Swift 中的方法分派 case</h3><blockquote><p>Note: 带有 <code>final</code> 关键字的方法属于静态分派；普通扩展中的「不被 @objc, dynamic 描述的」方法也属于静态分派。</p></blockquote><figure class="highlight swift"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">func</span> <span class="title">eat</span><span class="params">()</span></span> &#123; &#125;</span><br><span class="line">	<span class="meta">@objc</span> <span class="keyword">dynamic</span> <span class="function"><span class="keyword">func</span> <span class="title">getWild</span><span class="params">()</span></span> &#123; &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Dog</span>: <span class="title">Animal</span> </span>&#123;</span><br><span class="line">	<span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">eat</span><span class="params">()</span></span> &#123; &#125;	<span class="comment">// Compiled error!</span></span><br><span class="line">	<span class="meta">@objc</span> <span class="keyword">dynamic</span> <span class="keyword">override</span> <span class="function"><span class="keyword">func</span> <span class="title">getWild</span><span class="params">()</span></span> &#123; &#125; <span class="comment">// Ok :)</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">protocol</span> <span class="title">Noisy</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">func</span> <span class="title">makeNoise</span><span class="params">()</span></span> -&gt; <span class="type">Int</span>	<span class="comment">// Table Dispatch</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Noisy</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">func</span> <span class="title">makeNoise</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> &#123; <span class="keyword">return</span> <span class="number">0</span> &#125; <span class="comment">// Table Dispatch</span></span><br><span class="line">	<span class="function"><span class="keyword">func</span> <span class="title">isAnnoying</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123; <span class="keyword">return</span> <span class="literal">true</span> &#125; <span class="comment">// Static Dispatch, extension 中普工方法</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Animal</span>: <span class="title">Noisy</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">func</span> <span class="title">makeNoise</span><span class="params">()</span></span> -&gt; <span class="type">Int</span> &#123; <span class="keyword">return</span> <span class="number">1</span> &#125; <span class="comment">// Table Dispatch</span></span><br><span class="line">	<span class="function"><span class="keyword">func</span> <span class="title">isAnnoying</span><span class="params">()</span></span> -&gt; <span class="type">Bool</span> &#123; <span class="keyword">return</span> <span class="literal">false</span> &#125; <span class="comment">// Table Dispatch</span></span><br><span class="line">	<span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">sleep</span><span class="params">()</span></span> &#123; &#125;	<span class="comment">// Table Dispatch</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">extension</span> <span class="title">Animal</span> </span>&#123;</span><br><span class="line">	<span class="function"><span class="keyword">func</span> <span class="title">eat</span><span class="params">()</span></span> &#123; &#125; <span class="comment">// Static Dispatch, extension 中普工方法</span></span><br><span class="line">	<span class="meta">@objc</span> <span class="function"><span class="keyword">func</span> <span class="title">getWild</span><span class="params">()</span></span> &#123; &#125; <span class="comment">// Message Dispatch</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="参考"><a class="markdownIt-Anchor" href="#参考"></a> 参考</h3><ul><li><a href="https://trinhngocthuyen.github.io/posts/tech/method-dispatch-in-swift/" target="_blank" rel="noopener">Method dispatch in Swift</a></li><li><a href="https://forums.swift.org/t/making-the-value-witness-table-reference-relative/1206" target="_blank" rel="noopener">making-the-value-witness-table-reference-relative</a></li></ul></div><section class="post-copyright"><p class="copyright-item"><span>Author:</span> <span>David硕</span></p><p class="copyright-item"><span>Permalink:</span> <span><a href="http://davidxiaoshuo.github.io/iOS/swift_dynamic/">http://davidxiaoshuo.github.io/iOS/swift_dynamic/</a></span></p><p class="copyright-item"><span>License:</span> <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span></p><p class="copyright-item"><span>Slogan:</span> <span>Write readable code!</span></p></section><section class="post-tags"><div><span>Tag(s):</span> <span class="tag"><a href="/tags/swift/"># swift</a></span></div><div><a href="javascript:window.history.back();">back</a> <span>· </span><a href="/">home</a></div></section><section class="post-nav"><a class="next" rel="next" href="/iOS/swift_override_property/">Swift 总结之属性重写 「override」</a></section></article></div></div><footer id="footer" class="footer"><div class="copyright"><span>© David硕 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span></div></footer></div></body></html>
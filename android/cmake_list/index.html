<!DOCTYPE html>
<html lang="">

<head><meta name="generator" content="Hexo 3.9.0">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no">

    
      <link rel="icon" href="/favicon.ico">
    

    <title>
        
          android studio cmake 编译常规设置 - David小硕
        
    </title>

    <!-- Spectre.css framework (v0.5.8) -->
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-exp.min.css">
    <link rel="stylesheet" href="https://unpkg.com/spectre.css/dist/spectre-icons.min.css">

    <!-- Noto Sans TC -->
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC" rel="stylesheet">
    <!-- Noto Sans SC -->
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans+TC" rel="stylesheet">
    <!-- Noto Sans -->
    <link href="https://fonts.googleapis.com/css?family=Noto+Sans" rel="stylesheet">

    <!-- theme css & js -->
    <link rel="stylesheet" href="/css/spectre_custom.css">
    <link rel="stylesheet" href="/css/book.css">
    <script src="/js/book.js"></script>

    <!-- tocbot -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/tocbot/4.4.2/tocbot.css">

    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/styles/default.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.15.6/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    
    <!-- katex -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.10.0/katex.min.css">

    
<!-- Google Analytics -->
<script>
(function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
})(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

ga('create', 'UA-112717568-2', 'auto');
ga('send', 'pageview');
</script>
<!-- End Google Analytics -->

</head>

<body>

<div class="container">
  <div class="book-container">
    <div class="columns">
      <div class="column col-2 hide-lg">
        <div class="book-sidebar">
  <h4 class="site-meta">
    <a href="/">David小硕</a>
  </h4>
  <div class="sidebar-content">
    <ul>
<li>Tech
<ul>
<li>android
<ul>
<li><a href="/android/cmake_list">android studio cmake 编译常规设置</a></li>
</ul>
</li>
<li>c++
<ul>
<li><a href="/c++/cplus_type_convert">C++ 中 基础类型转换成 char*</a></li>
</ul>
</li>
<li>git
<ul>
<li><a href="/git/git_multi_account_themes">Git 多github（gitlab）账号管理</a></li>
</ul>
</li>
<li>others
<ul>
<li><a href="/others/hello_world">Hexo Page 简单发布流程</a></li>
<li><a href="/others/macos_terminal_themes">MacOS Terminal 美化 【程序猿推荐】</a></li>
</ul>
</li>
</ul>
</li>
<li>Life</li>
</ul>

  </div>
</div>

<script src="/js/book-sidebar.js"></script>
      </div>

      <div class="column col-8 col-lg-12">
        <div class="book-content">
          <div class="book-navbar">
  <header class="navbar">
  <section class="navbar-section">
    <img class="navbar-icon" src="/favicon.ico">
  </section>
  <section class="navbar-center">
    David小硕
  </section>
  <section class="navbar-section">
    <label class="accordion-header c-hand" for="accordion-sidebar">
      <i class="icon icon-menu"></i>
    </label>
  </section>
</header>

<div class="accordion">
  <input type="checkbox" id="accordion-sidebar" name="accordion-checkbox" hidden>
  <div class="accordion-body">
    <ul>
<li>Tech
<ul>
<li>android
<ul>
<li><a href="/android/cmake_list">android studio cmake 编译常规设置</a></li>
</ul>
</li>
<li>c++
<ul>
<li><a href="/c++/cplus_type_convert">C++ 中 基础类型转换成 char*</a></li>
</ul>
</li>
<li>git
<ul>
<li><a href="/git/git_multi_account_themes">Git 多github（gitlab）账号管理</a></li>
</ul>
</li>
<li>others
<ul>
<li><a href="/others/hello_world">Hexo Page 简单发布流程</a></li>
<li><a href="/others/macos_terminal_themes">MacOS Terminal 美化 【程序猿推荐】</a></li>
</ul>
</li>
</ul>
</li>
<li>Life</li>
</ul>

  </div>
</div>
</div>

<div class="book-post">
  <h1 id="android-studio-cmake-编译常规设置">android studio cmake 编译常规设置</h1>
<h4 id="1-add-executable-指令">1. add_executable 指令</h4>
<p>语法：add_executable(executable_file_name [source])<br>
将一组源文件 source 生成一个可执行文件。 source 可以是多个源文件，也可以是对应定义的变量<br>
如：add_executable(hello main.c)</p>
<h4 id="2-cmake-minimun-required-version-3-4-1">2. cmake_minimun_required(VERSION 3.4.1)</h4>
<p>用来指定 CMake 最低版本为3.4.1，如果没指定，执行 cmake 命令时可能会出错</p>
<h4 id="3-add-subdirectory-指令">3. add_subdirectory 指令</h4>
<p>语法：add_subdirectory(source_dir [binary_dir] [EXCLUDE_FROM_ALL])</p>
<p>这个指令用于向当前工程添加存放源文件的子目录，并可以指定中间二进制和目标二进制存放的位置。EXCLUDE_FROM_ALL参数含义是将这个目录从编译过程中排除。</p>
<p>另外，也可以通过 SET 指令重新定义 EXECUTABLE_OUTPUT_PATH 和 LIBRARY_OUTPUT_PATH 变量来指定最终的目标二进制的位置(指最终生成的 hello 或者最终的共享库，不包含编译生成的中间文件)</p>
<p>set(EXECUTABLE_OUTPUT_PATH ${PROJECT_BINARY_DIR}/bin)</p>
<p>set(LIBRARY_OUTPUT_PATH ${PROJECT_BINARY_DIR}/lib)</p>
<h4 id="4-add-library-指令">4. add_library 指令</h4>
<p>语法：add_library(libname [SHARED | STATIC | MODULE] [EXCLUDE_FROM_ALL] [source])</p>
<p>将一组源文件 source 编译出一个库文件，并保存为 <a href="http://libname.so" target="_blank" rel="noopener">libname.so</a> (lib 前缀是生成文件时 CMake自动添加上去的)。其中有三种库文件类型，<strong>不写的话，默认为 STATIC</strong>:</p>
<ul>
<li>SHARED: 表示动态库，可以在(Java)代码中使用<br>
<code>System.loadLibrary(name)</code><br>
动态调用；</li>
<li>STATIC: 表示静态库，集成到代码中会在编译时调用；</li>
<li>MODULE: 只有在使用 dyId 的系统有效，如果不支持 dyId，则被当作 SHARED 对待；</li>
<li>EXCLUDE_FROM_ALL: 表示这个库不被默认构建，除非其他组件依赖或手工构建<pre><code>#将compress.c 编译成 libcompress.so 的共享库
add_library(compress SHARED compress.c)
</code></pre>
</li>
</ul>
<p>add_library 命令也可以用来导入第三方的库:</p>
<p><code>add_library(libname [SHARED | STATIC | MODULE | UNKNOWN] IMPORTED)</code></p>
<p>如，导入 <a href="http://libjpeg.so" target="_blank" rel="noopener">libjpeg.so</a></p>
<pre><code>add_library(libjpeg SHARED IMPORTED)
</code></pre>
<p>导入库后，当需要使用 target_link_libraries 链接库时，可以直接使用该库</p>
<h4 id="5-find-library-指令">5. find_library 指令</h4>
<p>语法：find_library(</p>
<p>name1 path1 path2 …)</p>
<p>VAR 变量表示找到的库全路径，包含库文件名 。例如：</p>
<pre><code>find_library(libX  X11 /usr/lib)

find_library(log-lib log)
#路径为空，应该是查找系统环境变量路径
</code></pre>
<h4 id="6-set-target-properties-指令">6. set_target_properties 指令</h4>
<p>语法: set_target_properties(target1 target2 … PROPERTIES prop1 value1 prop2 value2 …)</p>
<p>这条指令可以用来设置输出的名称（设置构建同名的动态库和静态库，或者指定要导入的库文件的路径），对于动态库，还可以用来指定动态库版本和 API 版本。</p>
<p>如，set_target_properties(hello_static PROPERTIES OUTPUT_NAME “hello”)</p>
<p>设置同名的 hello 动态库和静态库：</p>
<pre><code>set_target_properties(hello PROPERTIES CLEAN_DIRECT_OUTPUT 1)

set_target_properties(hello_static PROPERTIES CLEAN_DIRECT_OUTPUT 1)
</code></pre>
<p>指定要导入的库文件的路径</p>
<pre><code>add_library(jpeg SHARED IMPORTED)
#注意要先 add_library，再 set_target_properties

set_target_properties(jpeg PROPERTIES IMPORTED_LOCATION ${PROJECT_SOURCE_DIR}/libs/${ANDROID_ABI}/libjpeg.so)
</code></pre>
<p>设置动态库 hello 版本和 API 版本：</p>
<p><code>set_target_properties(hello PROPERTIES VERSION 1.2 SOVERSION 1)</code></p>
<p>和它对应的指令：</p>
<p>get_target_property(VAR target property)</p>
<p>如上面的例子，获取输出的库的名字</p>
<pre><code>get_target_property(OUTPUT_VALUE hello_static OUTPUT_NAME)

message(STATUS &quot;this is the hello_static OUTPUT_NAME:&quot;${OUTPUT_VALUE})
</code></pre>
<h4 id="7-include-directories-指令">7.include_directories 指令</h4>
<p>语法：include_directories([AFTER | BEFORE] [SYSTEM] dir1 dir2…)</p>
<p>这个指令可以用来向工程添加多个特定的头文件搜索路径，路径之间用空格分割，如果路径中包含了空格，可以使用双引号将它括起来，默认的行为是追加到当前的头文件搜索路径的后面。</p>
<h4 id="8-target-link-libraries-指令">8. target_link_libraries 指令</h4>
<p>语法：target_link_libraries(target library</p>
<p>library2…)</p>
<p>这个指令可以用来为 target 添加需要的链接的共享库，同样也可以用于为自己编写的共享库添加共享库链接。</p>
<p>如：</p>
<pre><code>#指定 compress 工程需要用到 libjpeg 库和 log 库
target_link_libraries(compress libjpeg ${log-lib})
</code></pre>
<p>同样，link_directories(directory1 directory2 …) 可以添加非标准的共享库搜索路径。</p>
<p>还有其他 file、list、install 、find_ 指令和控制指令等就不介绍了，详细可以查看手册。</p>
<h3 id="9-cmake-的常用变量">9. CMake 的常用变量</h3>
<h4 id="9-1-变量引用方式">9.1 变量引用方式</h4>
<p>使用 ${} 进行变量的引用。不过在 IF 等语句中，可以直接使用变量名而不用通过 ${} 取值</p>
<h4 id="9-2-自定义变量的方式">9.2 自定义变量的方式</h4>
<p>主要有隐式定义和显式定义两种。隐式定义，如 PROJECT 指令会隐式定义</p>
<p>_BINARY_DIR 和</p>
<p>_SOURCE_DIR</p>
<p>而对于显式定义就是通过 SET 指令来定义。如：set(HELLO_SRC main.c)</p>
<h4 id="9-3-cmake-常用变量">9.3 CMake 常用变量</h4>
<ul>
<li>
<p>1）CMAKE_BINARY_DIR, PROJECT_BINARY_DIR,<br>
_BINARY_DIR</p>
<p>这三个变量指代的内容都是一样的，如果是 in-source 编译，指的是工程顶层目录，如果是 out-of-source 编译，指的是工程编译发生的目录。</p>
</li>
<li>
<p>2）CMAKE_SOURCE_DIR, PROJECT_SOURCE_DIR,<br>
_SOURCE_DIR</p>
<p>这三个变量指代的内容也是一样的，不论哪种编译方式，都是工程顶层目录。</p>
</li>
<li>
<p>3）CMAKE_CURRENT_SOURCE_DIR</p>
<p>当前处理的 CMakeLists.txt 所在的路径</p>
</li>
<li>
<p>4）CMAKE_CURRENT_BINARY_DIR</p>
<p>如果是 in-source 编译，它跟 CMAKE_CURRENT_SOURCE_DIR 一致，如果是 out-of-source 编译，指的是 target 编译目录。</p>
<p>使用 ADD_SUBDIRECTORY(src bin)可以修改这个变量的值；</p>
<p>而使用 SET(EXECUTABLE_OUTPUT_PATH &lt; 新路径&gt;) 并不会对这个变量造成影响，它仅仅修改了最终目标文件存放的路径。</p>
</li>
<li>
<p>5）CMAKE_CURRENT_LIST_FILE</p>
<p>输出调用这个变量的 CMakeLists.txt 的完整路径</p>
</li>
<li>
<p>6）CMAKE_CURRENT_LIST_LINE</p>
<p>输出这个变量所在的行</p>
</li>
<li>
<p>7）CMAKE_MODULE_PATH</p>
<p>这个变量用来定义自己的 CMake 模块所在的路径。如果你的工程比较复杂，有可能会自己</p>
<p>编写一些 cmake 模块，这些 cmake 模块是随你的工程发布的，为了让 cmake 在处理</p>
<p>CMakeLists.txt 时找到这些模块，你需要通过 SET 指令，将自己的 cmake 模块路径设</p>
<p>置一下。</p>
<p>比如 SET(CMAKE_MODULE_PATH ${PROJECT_SOURCE_DIR}/cmake)</p>
<p>这时候你就可以通过 INCLUDE 指令来调用自己的模块了。</p>
</li>
<li>
<p>８）EXECUTABLE_OUTPUT_PATH 和 LIBRARY_OUTPUT_PATH</p>
<p>分别用来重新定义最终结果的存放目录，前面我们已经提到了这两个变量。</p>
</li>
<li>
<p>9）PROJECT_NAME</p>
<p>返回通过 PROJECT 指令定义的项目名称。</p>
</li>
</ul>
<h3 id="android-cmake-的使用">Android CMake 的使用</h3>
<h4 id="8-1-cmakelist-txt-的编写">8.1 CMakeList.txt 的编写</h4>
<p>再回归到 Android NDK 开发中 CMake 的使用，先看一个系统生成的 NDK 项目的 CMakeLists.txt 的配置：( 去掉原有的注释)</p>
<pre><code>#设置编译 native library 需要最小的 cmake 版本

cmake_minimum_required(VERSION 3.4.1)
#将指定的源文件编译为名为 libnative-lib.so 的动态库
add_library
(native-lib SHARED src/main/cpp/native-lib.cpp)
#查找本地 log 库
find_library
(log-lib log)
#将预构建的库添加到自己的原生库
target_link_libraries
(native-lib ${log-lib})
</code></pre>
<p>复杂一点的 CMakeLists，这是一个本地使用 <a href="http://libjpeg.so" target="_blank" rel="noopener">libjpeg.so</a> 来做图片压缩的项目</p>
<pre><code>cmake_minimum_required(VERSION 3.4.1)
#设置生成的so动态库最后输出的路径
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${PROJECT_SOURCE_DIR}/src/main/jniLibs/${ANDROID_ABI})
#指定要引用的libjpeg.so的头文件目录
set(LIBJPEG_INCLUDE_DIR src/main/cpp/include)
include_directories(${LIBJPEG_INCLUDE_DIR})

#导入libjpeg动态库 SHARED；静态库为STATIC
add_library(jpeg SHARED IMPORTED)

#对应so目录，注意要先 add_library，再 set_target_properties）
set_target_properties(jpeg PROPERTIES IMPORTED_LOCATION ${PROJECT_SOURCE_DIR}/libs/${ANDROID_ABI}/libjpeg.so)

add_library(compress SHARED src/main/cpp/compress.c)

find_library(graphics jnigraphics)
find_library(log-lib log)

#添加链接上面个所 find 和 add 的 library
target_link_libraries(compress jpeg ${log-lib} ${graphics})
</code></pre>
<h4 id="配置-gradle">配置 Gradle</h4>
<p>简单的配置如下，至于 cppFlags 或 cFlags 的参数有点复杂，一般设置为空或不设置也是可以的，这里就不过多介绍了</p>
<pre><code>android {
compileSdkVersion 25
buildToolsVersion &quot;25.0.3&quot;

defaultConfig {
    minSdkVersion 15
    targetSdkVersion 25
    versionCode 1
    versionName &quot;1.0&quot;
    externalNativeBuild {
        cmake {
            // Passes optional arguments to CMake.
            arguments 
            &quot;-DANDROID_ARM_NEON=TRUE&quot;,
            &quot;-DANDROID_TOOLCHAIN=clang&quot;
            // Sets optional flags for the C compiler.
            cFlags &quot;-D_EXAMPLE_C_FLAG1&quot;,&quot;-D_EXAMPLE_C_FLAG2&quot;
            // Sets a flag to enable format macro constants for the C++ compiler.
            cppFlags &quot;-D__STDC_FORMAT_MACROS&quot;
            //生成.so库的目标平台
            abiFilters 'x86','x86_64','armeabi','armeabi-v7a','arm64-v8a'
        }
    }
}
//配置 CMakeLists.txt 路径
externalNativeBuild {
     cmake {
        path &quot;CMakeLists.txt&quot;
    }
}
</code></pre>

</div>


  <div class="book-comments">
    


  </div>


<script src="/js/book-post.js"></script>
        </div>
      </div>

      <div class="column col-2 hide-lg">
        <div class="book-toc">
  <div class="book-tocbot">
  </div>
  <div class="book-tocbot-menu">
    <a class="book-toc-expand" onclick="expand_toc()">Expand all</a>
    <a onclick="go_top()">Back to top</a>
    <a onclick="go_bottom()">Go to bottom</a>
  </div>
</div>

<script>
tocbot.init({
  tocSelector: '.book-tocbot',
  contentSelector: '.book-post',
  headingSelector: 'h1, h2, h3, h4, h5',
  collapseDepth: 2,
  orderedList: false,
  scrollSmooth: false,
});

function expand_toc(){
  var b = document.querySelector(".book-toc-expand");
  tocbot.init({
    tocSelector: '.book-tocbot',
    contentSelector: '.book-post',
    headingSelector: 'h1, h2, h3, h4, h5',
    collapseDepth: 6,
    orderedList: false,
    scrollSmooth: false,
  });
  b.setAttribute("onclick", "collapse_toc()");
  b.innerHTML = "Collapse all"
}

function collapse_toc(){
  var b = document.querySelector(".book-toc-expand");
  tocbot.init({
    tocSelector: '.book-tocbot',
    contentSelector: '.book-post',
    headingSelector: 'h1, h2, h3, h4, h5',
    collapseDepth: 2,
    orderedList: false,
    scrollSmooth: false,
  });
  b.setAttribute("onclick", "expand_toc()");
  b.innerHTML = "Expand all"
}

function go_top() {
  window.scrollTo(0, 0);
}

function go_bottom() {
  window.scrollTo(0, document.body.scrollHeight);
}

</script>
      </div>
    </div>
  </div>
</div>

</body>
</html>

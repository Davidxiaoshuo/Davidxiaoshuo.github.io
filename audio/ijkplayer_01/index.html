<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1"><meta http-equiv="X-UA-Compatible" content="ie=edge"><meta name="author" content="David硕"><meta name="subtitle" content="write readable code"><meta name="description" content="在这个薄情的世界，深情地活着"><title>IjkPlayer 从编译集成到简单音频播放器的封装 [Android &amp; iOS] 一 | David硕</title><link rel="icon" href="/favicon.ico"><link rel="stylesheet" href="/css/style.css"><script src="/js/script.js"></script><script src="/js/tocbot.min.js"></script></head><body><div class="wrapper"><header><nav class="navbar"><div class="container"><div class="navbar-header header-logo"><a href="/">David硕&#39;s Blog</a></div><div class="menu navbar-right"><a class="menu-item" href="/archives">Posts</a> <a class="menu-item" href="/category">Categories</a> <a class="menu-item" href="/tag">Tags</a> <a class="menu-item" href="/about">About</a> <input id="switch_default" type="checkbox" class="switch_default"> <label for="switch_default" class="toggleBtn"></label></div></div></nav><nav class="navbar-mobile" id="nav-mobile"><div class="container"><div class="navbar-header"><div><a href="/">David硕&#39;s Blog</a><a id="mobile-toggle-theme">·&nbsp;Light</a></div><div class="menu-toggle" onclick="mobileBtn()">&#9776; Menu</div></div><div class="menu" id="mobile-menu"><a class="menu-item" href="/archives">Posts</a> <a class="menu-item" href="/category">Categories</a> <a class="menu-item" href="/tag">Tags</a> <a class="menu-item" href="/about">About</a></div></div></nav></header><script>var mobileBtn=function(){var e=document.getElementsByClassName("menu-toggle")[0],t=document.getElementById("mobile-menu");e.classList.contains("active")?(e.classList.remove("active"),t.classList.remove("active")):(e.classList.add("active"),t.classList.add("active"))}</script><div class="main"><div class="container"><div class="post-toc"><div class="tocbot-list"></div><div class="tocbot-list-menu"><a class="tocbot-toc-expand" onclick="expand_toc()">Expand all</a> <a onclick="go_top()">Back to top</a> <a onclick="go_bottom()">Go to bottom</a></div></div><script>function expand_toc(){var o=document.querySelector(".tocbot-toc-expand");tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:6,orderedList:!1,scrollSmooth:!0}),o.setAttribute("onclick","collapse_toc()"),o.innerHTML="Collapse all"}function collapse_toc(){var o=document.querySelector(".tocbot-toc-expand");tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:1,orderedList:!1,scrollSmooth:!0}),o.setAttribute("onclick","expand_toc()"),o.innerHTML="Expand all"}function go_top(){window.scrollTo(0,0)}function go_bottom(){window.scrollTo(0,document.body.scrollHeight)}document.ready(function(){tocbot.init({tocSelector:".tocbot-list",contentSelector:".post-content",headingSelector:"h1, h2, h3, h4, h5",collapseDepth:1,orderedList:!1,scrollSmooth:!0})})</script><article class="post-wrap"><header class="post-header"><h1 class="post-title">IjkPlayer 从编译集成到简单音频播放器的封装 [Android &amp; iOS] 一</h1><div class="post-meta">Author: <a itemprop="author" rel="author" href="/">David硕</a> <span class="post-time">Date: <a href="#">十一月 20, 2019&nbsp;&nbsp;17:33:38</a> </span><span class="post-category">Category: <a href="/categories/Android/">Android</a></span></div></header><div class="post-content"><h2 id="编译篇【Android】"><a class="header-anchor" href="#编译篇【Android】"></a>编译篇【Android】</h2><h3 id="背景"><a class="header-anchor" href="#背景"></a>背景</h3><p>IjkPlayer 是 <code>bilibili</code> 团队出品的一款基于 FFmpeg 的轻量级的音视频播放器。<br><br>官方地址： <a href="https://github.com/bilibili/ijkplayer" target="_blank" rel="noopener">ijkplayer</a><br><br>由于我所在项目需要一款音频播放器，所以后面都是基于这个大前提来做的。</p><h3 id="环境准备"><a class="header-anchor" href="#环境准备"></a>环境准备</h3><ul><li>编译环境：macOS</li><li>所需要工具：homebrew 【软件包管理器】, git 【分散式版本控制工具】, yasm 【汇编编译器】</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># 安装 homebrew</span></span><br><span class="line">ruby -e <span class="string">"<span class="variable">$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install)</span>"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 git</span></span><br><span class="line">brew install git</span><br><span class="line"></span><br><span class="line"><span class="comment"># 安装 yasm</span></span><br><span class="line">brew install yasm</span><br></pre></td></tr></table></figure><ul><li>配置环境变量：</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># add these lines to your ~/.bash_profile or ~/.profile or ~/.zshrc (取决于你使用的终端工具)</span></span><br><span class="line"><span class="built_in">export</span> ANDROID_SDK=&lt;your sdk path&gt;</span><br><span class="line"><span class="built_in">export</span> ANDROID_NDK=&lt;your ndk path&gt; 【最好区别于你的开发环境变量配置】</span><br></pre></td></tr></table></figure><blockquote><p><strong>Note： 由于 ijkplayer 代码比较古老了，NDK 环境最好选择 <code>14</code> 版本。 NDK 下载<a href="https://developer.android.com/ndk/downloads/older_releases.html#ndk-14b-downloads" target="_blank" rel="noopener">链接</a></strong></p></blockquote><h3 id="编译"><a class="header-anchor" href="#编译"></a>编译</h3><ul><li>通过 <code>git</code> 将 ijkplayer 源码 clone 到本地</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">git <span class="built_in">clone</span> https://github.com/bilibili/ijkplayer.git &lt;you <span class="built_in">local</span> path&gt;</span><br></pre></td></tr></table></figure><ul><li>下载 FFmpeg</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./init-android.sh</span><br></pre></td></tr></table></figure><ul><li>下载 OpenSSL, 增加 <code>https</code> 支持</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">./init-android-openssl.sh</span><br></pre></td></tr></table></figure><ul><li>编译 OpenSSL</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> android/contrib</span><br><span class="line"></span><br><span class="line">./compile-openssl.sh clean</span><br><span class="line"></span><br><span class="line">./compile-openssl.sh all</span><br></pre></td></tr></table></figure><ul><li>编译 FFmpeg</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> android/contrib</span><br><span class="line"></span><br><span class="line">./compile-ffmpeg.sh clean</span><br><span class="line"></span><br><span class="line">./compile-ffmpeg.sh all</span><br></pre></td></tr></table></figure><ul><li>编译 ijkplayer</li></ul><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">cd android</span><br><span class="line"></span><br><span class="line">./compile-ijk<span class="selector-class">.sh</span> clean</span><br><span class="line"></span><br><span class="line">./compile-ijk<span class="selector-class">.sh</span> all</span><br></pre></td></tr></table></figure><blockquote><p><strong>Note: 编译说明：</strong><br></p><p><code>compile-openssl.sh</code> &amp; <code>compile-ffmpeg.sh</code> &amp; <code>compile-ijk.sh</code> 后面的参数代表要变哪个CPU架构的版本，默认是 <code>armv7a</code>；<br></p><figure class="highlight smali"><table><tr><td class="code"><pre><span class="line">armv5 armv7a arm64 x86 x86_64(指定编译哪个版本)</span><br><span class="line">all32（所有32位处理器版本，包含armv5 armv7a x86</span><br><span class="line">all （所有通用版本，包含armv5 armv7a arm64 x86 x86_64)</span><br><span class="line">clean （清除之前编译的缓存）</span><br><span class="line">check (检测支持的版本)</span><br></pre></td></tr></table></figure></blockquote><h3 id="编译-FFmpeg-说明"><a class="header-anchor" href="#编译-FFmpeg-说明"></a>编译 FFmpeg 说明</h3><p>编译 ffmpeg 时，根据自己的需求来确定你需要的是更多的 <code>codec/format</code>, 还是轻量级的 <code>codec/format</code> 就可以了。【官方文档有描述。后面将会专门讲配置特定需求的 codec/format】</p><ul><li>if you prefer more codec/format</li></ul><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">cd config</span><br><span class="line">rm module.sh</span><br><span class="line">ln -s module-default.sh module.sh</span><br><span class="line">cd android/contrib</span><br><span class="line"><span class="comment"># cd ios</span></span><br><span class="line">sh compile-ffmpeg.sh clean</span><br></pre></td></tr></table></figure><ul><li>if you prefer less codec/format for smaller binary size (include hevc function) 【hevc: HEVC是High Efficiency Video Coding的缩写，是一种新的视频压缩标准，用来以替代H.264/AVC编码标准，2013年1月26号，HEVC正式成为国际标准。】</li></ul><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">cd config</span><br><span class="line">rm module.sh</span><br><span class="line">ln -s module-lite-hevc.sh module.sh</span><br><span class="line">cd android/contrib</span><br><span class="line"><span class="comment"># cd ios</span></span><br><span class="line">sh compile-ffmpeg.sh clean</span><br></pre></td></tr></table></figure><ul><li>if you prefer less codec/format for smaller binnary size (by default)</li></ul><figure class="highlight routeros"><table><tr><td class="code"><pre><span class="line">cd config</span><br><span class="line">rm module.sh</span><br><span class="line">ln -s module-lite.sh module.sh</span><br><span class="line">cd android/contrib</span><br><span class="line"><span class="comment"># cd ios</span></span><br><span class="line">sh compile-ffmpeg.sh clean</span><br></pre></td></tr></table></figure><h2 id="编译中遇到的问题"><a class="header-anchor" href="#编译中遇到的问题"></a>编译中遇到的问题</h2><h3 id="NDK-版本引起的问题，强烈建议选择-r14b-版本，上面有-ndk-下载链接"><a class="header-anchor" href="#NDK-版本引起的问题，强烈建议选择-r14b-版本，上面有-ndk-下载链接"></a>NDK 版本引起的问题，<em><strong>强烈建议选择 <code>r14b</code> 版本，上面有 ndk 下载链接</strong></em></h3><ul><li>确认你的 NDK 版本是否大于等于 r10e</li></ul><figure class="highlight stylus"><table><tr><td class="code"><pre><span class="line">cat <span class="variable">$ANDROID_NDK</span>/source.properties</span><br><span class="line"></span><br><span class="line">Pkg<span class="selector-class">.Desc</span> = Android NDK</span><br><span class="line">Pkg<span class="selector-class">.Revision</span> = <span class="number">14.1</span>.<span class="number">3816874</span> <span class="comment">// 我的NDK版本</span></span><br></pre></td></tr></table></figure><ul><li>确定了你的 NDK 版本符合要求，还是报了如下错误</li></ul><figure class="highlight livecodeserver"><table><tr><td class="code"><pre><span class="line">You need <span class="keyword">the</span> NDKr10e <span class="keyword">or</span> later</span><br></pre></td></tr></table></figure><p>那么你就要需要修改如下代码, 把你的版本添加进版本检查中：</p><figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cd</span> android/contrib/tool</span><br><span class="line"></span><br><span class="line">vim <span class="keyword">do</span>-detect-env.sh</span><br><span class="line"></span><br><span class="line">IJK_NDK_REL=$(grep -o <span class="string">'^Pkg\.Revision.*=[0-9]*.*'</span> <span class="variable">$ANDROID_NDK</span>/source.properties 2&gt;/dev/null | sed <span class="string">'s/[[:space:]]*//g'</span> | cut -d <span class="string">"="</span> -f 2)</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"IJK_NDK_REL=<span class="variable">$IJK_NDK_REL</span>"</span></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$IJK_NDK_REL</span>"</span> <span class="keyword">in</span></span><br><span class="line">    11*|12*|13*|14*|15*|20*)</span><br><span class="line">        <span class="keyword">if</span> <span class="built_in">test</span> -d <span class="variable">$&#123;ANDROID_NDK&#125;</span>/toolchains/arm-linux-androideabi-4.9</span><br><span class="line">        <span class="keyword">then</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"NDKr<span class="variable">$IJK_NDK_REL</span> detected"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"You need the NDKr10e or later"</span></span><br><span class="line">            <span class="built_in">exit</span> 1</span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    ;;</span><br><span class="line">    *)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"You need the NDKr10e or later"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">    ;;</span><br></pre></td></tr></table></figure><ul><li>由于 ndk 兼容问题导致 standalone toolchain， 如果 <code>macOS</code> 遇到这个问题，可以将使用 <code>r14b</code> 版本的 NDK； 参考<a href="https://github.com/Bilibili/ijkplayer/issues/3378" target="_blank" rel="noopener">链接</a></li></ul><figure class="highlight asciidoc"><table><tr><td class="code"><pre><span class="line">====================</span><br><span class="line">[<span class="strong">*] check archs</span></span><br><span class="line"><span class="strong">====================</span></span><br><span class="line"><span class="strong">FF_ALL_ARCHS = armv5 armv7a arm64 x86 x86_64</span></span><br><span class="line"><span class="strong">FF_ACT_ARCHS = armv5 armv7a arm64 x86 x86_64</span></span><br><span class="line"><span class="strong"></span></span><br><span class="line"><span class="strong"></span></span><br><span class="line"><span class="strong">--------------------</span></span><br><span class="line"><span class="strong">[*</span>] make NDK standalone toolchain</span><br><span class="line">--------------------</span><br><span class="line">build on Darwin x86<span class="emphasis">_64</span></span><br><span class="line"><span class="emphasis">ANDROID_</span>NDK=/Users/davidxiaoshuo/Documents/dev<span class="emphasis">_tools/android/sdk/ndk-bundle</span></span><br><span class="line"><span class="emphasis">IJK_</span>NDK<span class="emphasis">_REL=20.0.5594570</span></span><br><span class="line"><span class="emphasis">NDKr20.0.5594570 detected</span></span><br><span class="line"><span class="emphasis"></span></span><br><span class="line"><span class="emphasis">--------------------</span></span><br><span class="line"><span class="emphasis">[*] make NDK standalone toolchain</span></span><br><span class="line"><span class="emphasis">--------------------</span></span><br><span class="line"><span class="emphasis">build on Darwin x86_</span>64</span><br><span class="line">ANDROID<span class="emphasis">_NDK=/Users/davidxiaoshuo/Documents/dev_</span>tools/android/sdk/ndk-bundle</span><br><span class="line">IJK<span class="emphasis">_NDK_</span>REL=20.0.5594570</span><br><span class="line">NDKr20.0.5594570 detected</span><br><span class="line">HOST<span class="emphasis">_OS=darwin</span></span><br><span class="line"><span class="emphasis">HOST_</span>EXE=</span><br><span class="line">HOST<span class="emphasis">_ARCH=x86_</span>64</span><br><span class="line">HOST<span class="emphasis">_TAG=darwin-x86_</span>64</span><br><span class="line">HOST<span class="emphasis">_NUM_</span>CPUS=12</span><br><span class="line">BUILD<span class="emphasis">_NUM_</span>CPUS=24</span><br><span class="line">Auto-config: --arch=arm</span><br><span class="line">ERROR: Failed to create toolchain.</span><br></pre></td></tr></table></figure><h3 id="其他方面导致的问题"><a class="header-anchor" href="#其他方面导致的问题"></a>其他方面导致的问题</h3><ul><li>编译模型脚本 （<a href="http://module.sh" target="_blank" rel="noopener">module.sh</a>）导致的问题</li></ul><figure class="highlight"><table><tr><td class="code"><pre><span class="line"><span class="attribute">WARNING</span>: arm-linux-androideabi-pkg-config not found, library detection may fail.</span><br><span class="line"></span><br><span class="line">--------------------</span><br><span class="line">[*] compile ffmpeg</span><br><span class="line">--------------------</span><br><span class="line">In file included from ./libavutil/internal.h:42:0,</span><br><span class="line">                 from ./libavutil/common.h:467,</span><br><span class="line">                 from ./libavutil/avutil.h:296,</span><br><span class="line">                 from ./libavutil/opt.h:31,</span><br><span class="line">                 from libavfilter/af_adelay.c:22:</span><br><span class="line">./libavutil/timer.h:38:31: fatal error: linux/perf_event.h: No such file or directory</span><br><span class="line"> # include &lt;linux/perf_event.h&gt;</span><br><span class="line">                               ^</span><br><span class="line">compilation terminated.</span><br><span class="line">In file included from ./libavutil/internal.h:42:0,</span><br><span class="line">                 from ./libavutil/common.h:467,</span><br><span class="line">                 from ./libavutil/avutil.h:296,</span><br><span class="line">                 from libavfilter/avfilter.h:41,</span><br><span class="line">                 from libavfilter/audio.h:25,</span><br><span class="line">                 from libavfilter/af_acopy.c:19:</span><br><span class="line">./libavutil/timer.h:38:31: fatal error: linux/perf_event.h: No such file or directory</span><br><span class="line"> # include &lt;linux/perf_event.h&gt;</span><br></pre></td></tr></table></figure><p>可以在 <code>module.sh</code> 最后添加 <code>export COMMON_FF_CFG_FLAGS=&quot;$COMMON_FF_CFG_FLAGS --disable-linux-perf&quot;</code> 这行代码。 参考<a href="https://github.com/Bilibili/ijkplayer/issues/4043" target="_blank" rel="noopener">链接</a></p></div><section class="post-copyright"><p class="copyright-item"><span>Author:</span> <span>David硕</span></p><p class="copyright-item"><span>Permalink:</span> <span><a href="http://davidxiaoshuo.github.io/audio/ijkplayer_01/">http://davidxiaoshuo.github.io/audio/ijkplayer_01/</a></span></p><p class="copyright-item"><span>License:</span> <span>Copyright (c) 2019 <a href="http://creativecommons.org/licenses/by-nc/4.0/">CC-BY-NC-4.0</a> LICENSE</span></p><p class="copyright-item"><span>Slogan:</span> <span>Write readable code!</span></p></section><section class="post-tags"><div><span>Tag(s):</span> <span class="tag"><a href="/tags/android/"># android</a> <a href="/tags/audio/"># audio</a></span></div><div><a href="javascript:window.history.back();">back</a> <span>· </span><a href="/">home</a></div></section><section class="post-nav"><a class="prev" rel="prev" href="/iOS/swift_keyword_summary/">Swift 总结之关键字</a> <a class="next" rel="next" href="/android/android_jni_one/">Android Jni 一</a></section></article></div></div><footer id="footer" class="footer"><div class="copyright"><span>© David硕 | Powered by <a href="https://hexo.io" target="_blank">Hexo</a> & <a href="https://github.com/Siricee/hexo-theme-Chic" target="_blank">Chic</a></span></div></footer></div></body></html>